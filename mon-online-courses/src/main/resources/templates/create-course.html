<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Course</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chip { transition: all 0.2s ease; cursor: pointer; }
        .chip:hover { transform: scale(1.05); }
        .neumorphic {
            border-radius: 12px;
            background: #ecf0f3;
            box-shadow: 6px 6px 10px #d1d9e6, -6px -6px 10px #ffffff;
            padding: 0.5rem 1rem;
            outline: none;
            width: 100%;
        }
        .neumorphic:focus {
            box-shadow: inset 2px 2px 5px #d1d9e6, inset -2px -2px 5px #ffffff;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-100 min-h-screen flex items-center justify-center">

<div class="bg-white shadow-2xl rounded-3xl p-8 w-full max-w-3xl">
    <h1 class="text-3xl font-bold text-center mb-6 text-indigo-700 drop-shadow-lg">ðŸš€ Create Your Course</h1>

    <form id="courseForm" class="space-y-6">

        <!-- Course Name -->
        <div>
            <label class="font-semibold text-gray-700 mb-1 block">Course Name</label>
            <input type="text" name="courseName" class="neumorphic" placeholder="Enter course name" required>
        </div>

        <!-- Course Description -->
        <div>
            <label class="font-semibold text-gray-700 mb-1 block">Course Description</label>
            <textarea name="courseDescription" rows="4" class="neumorphic" placeholder="Brief description of the course" required></textarea>
        </div>

        <!-- Course Price and Language -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <label class="font-semibold text-gray-700 mb-1 block">Price ($)</label>
                <input type="number" step="0.01" name="coursePrice" class="neumorphic" placeholder="e.g. 49.99" required>
            </div>
            <div>
                <label class="font-semibold text-gray-700 mb-1 block">Language</label>
                <input type="text" name="courseLanguage" class="neumorphic" placeholder="e.g. English" required>
            </div>
        </div>

        <!-- Categories -->
        <div>
            <label class="font-semibold text-gray-700 mb-1 block">Categories</label>
            <div id="categoriesContainer" class="flex flex-wrap gap-2 mb-2"></div>
            <div id="selectedCategoriesContainer" class="flex flex-wrap gap-2 mb-2"></div>
            <button type="button" id="addCategoryBtn" class="px-3 py-1 bg-indigo-500 text-white rounded-lg shadow-md hover:bg-indigo-600 transition">+ Add Category</button>
        </div>

        <!-- Tags -->
        <div>
            <label class="font-semibold text-gray-700 mb-1 block">Tags</label>
            <div id="existingTagsContainer" class="flex flex-wrap gap-2 mb-2"></div>
            <div id="selectedTagsContainer" class="flex flex-wrap gap-2 mb-2"></div>
            <input type="text" id="newTags" placeholder="New tags, comma-separated" class="neumorphic">
        </div>

        <!-- Course Image -->
        <div>
            <label class="font-semibold text-gray-700 mb-1 block">Course Image</label>
            <input type="file" name="courseImage" accept="image/*" id="courseImage" class="neumorphic" required>
            <img id="imagePreview" class="mt-2 w-full h-48 object-cover rounded-lg hidden" />
        </div>

        <!-- Submit -->
        <button type="submit" class="w-full bg-indigo-500 text-white py-3 rounded-xl font-bold hover:bg-indigo-600 transition shadow-lg">
            Create Course
        </button>
    </form>
</div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black/40 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl p-6 w-80 shadow-2xl space-y-4">
        <h2 class="text-xl font-bold text-indigo-700" id="modalTitle">Add New Item</h2>
        <input type="text" id="modalInput" class="neumorphic" placeholder="Enter name">
        <div class="flex justify-end gap-3">
            <button class="px-3 py-1 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition" onclick="saveModal()">Save</button>
            <button class="px-3 py-1 bg-gray-300 rounded-lg hover:bg-gray-400 transition" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:4000";
    const token = "Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJtc2hsb29sMzhAZ21haWwuY29tIiwicm9sZSI6Imluc3RydWN0b3IiLCJmdWxsTmFtZSI6Im1vaGFtYWQiLCJpYXQiOjE3NTYyMjY2NjUsImV4cCI6MTc1NjI2MjY2NX0.wEPLqzW-nhzIweZlBhJTspsBqGOnTHkwXhC8sr7yyrA";

    let selectedTags = new Set();
    let selectedCategories = new Set();
    let currentModalType = "";

    const modal = document.getElementById("modal");
    const modalInput = document.getElementById("modalInput");

    // Image preview
    document.getElementById("courseImage").addEventListener("change", e => {
        const file = e.target.files[0];
        const preview = document.getElementById("imagePreview");
        if(file){
            preview.src = URL.createObjectURL(file);
            preview.classList.remove("hidden");
        } else {
            preview.classList.add("hidden");
        }
    });

    // Load categories
    async function loadCategories() {
        try {
            const res = await fetch(`${API_BASE}/category/show-all-categorise`, { headers: { Authorization: token } });
            const data = await res.json();
            const container = document.getElementById("categoriesContainer");
            container.innerHTML = "";
            data.forEach(cat => {
                const btn = document.createElement("span");
                btn.textContent = cat.name;
                btn.className = "chip px-2 py-1 border rounded-full cursor-pointer hover:bg-indigo-100";
                btn.addEventListener("click", () => toggleCategory(cat.name, btn));
                container.appendChild(btn);
            });
        } catch (e) { console.error("Category load error:", e); }
    }

    function toggleCategory(name, btn){
        if(selectedCategories.has(name)){
            selectedCategories.delete(name);
            btn.classList.remove("bg-indigo-500","text-white");
        } else {
            selectedCategories.add(name);
            btn.classList.add("bg-indigo-500","text-white");
        }
        renderSelectedCategories();
    }

    function renderSelectedCategories(){
        const container = document.getElementById("selectedCategoriesContainer");
        container.innerHTML = "";
        selectedCategories.forEach(name => {
            const span = document.createElement("span");
            span.textContent = name;
            span.className = "chip px-2 py-1 bg-indigo-500 text-white rounded-full cursor-pointer";
            span.addEventListener("click", () => {
                selectedCategories.delete(name);
                renderSelectedCategories();
                document.querySelectorAll("#categoriesContainer span").forEach(btn => {
                    if(btn.textContent===name) btn.classList.remove("bg-indigo-500","text-white");
                });
            });
            container.appendChild(span);
        });
    }

    // Modal logic
    document.getElementById("addCategoryBtn").addEventListener("click", ()=>{
        currentModalType="category";
        modal.classList.remove("hidden");
        modalInput.value="";
        modalInput.focus();
    });
    function closeModal(){ modal.classList.add("hidden"); }
    async function saveModal(){
        const name = modalInput.value.trim();
        if(!name){ alert("Name cannot be empty"); return; }
        if(currentModalType==="category"){
            try{
                await fetch(`${API_BASE}/category/create-category`, {
                    method:"POST",
                    headers: { "Content-Type": "application/json", "Authorization": token },
                    body: JSON.stringify({ categoryName: name })
                });
                selectedCategories.add(name);
                renderSelectedCategories();
                loadCategories();
            } catch(e){ alert("Failed to create category"); console.error(e); }
        }
        closeModal();
    }

    // Tags
    async function loadTags(){
        try{
            const res = await fetch(`${API_BASE}/tag/show-all-tags`, { headers:{Authorization:token}});
            const tags = await res.json();
            const container = document.getElementById("existingTagsContainer");
            container.innerHTML="";
            tags.forEach(tag=>{
                const btn = document.createElement("span");
                btn.textContent = tag.tagName;
                btn.className="chip px-2 py-1 border rounded-full cursor-pointer hover:bg-indigo-100";
                btn.addEventListener("click",()=>toggleTag(tag.tagName, btn));
                container.appendChild(btn);
            });
        } catch(e){ console.error(e);}
    }

    function toggleTag(tagName, btn){
        if(selectedTags.has(tagName)){
            selectedTags.delete(tagName);
            btn.classList.remove("bg-indigo-500","text-white");
        } else {
            selectedTags.add(tagName);
            btn.classList.add("bg-indigo-500","text-white");
        }
        renderSelectedTags();
    }

    function renderSelectedTags(){
        const container = document.getElementById("selectedTagsContainer");
        container.innerHTML="";
        selectedTags.forEach(tag=>{
            const span = document.createElement("span");
            span.textContent = tag;
            span.className="chip px-2 py-1 bg-indigo-500 text-white rounded-full cursor-pointer";
            span.addEventListener("click",()=>{
                selectedTags.delete(tag);
                renderSelectedTags();
                document.querySelectorAll("#existingTagsContainer span").forEach(btn=>{
                    if(btn.textContent===tag) btn.classList.remove("bg-indigo-500","text-white");
                });
            });
            container.appendChild(span);
        });
    }

    // Form submit
    document.getElementById("courseForm").addEventListener("submit", async e=>{
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        const newTagsInput = document.getElementById("newTags").value.split(",").map(t=>t.trim()).filter(t=>t);
        newTagsInput.forEach(t=>selectedTags.add(t));

        if(newTagsInput.length>0){
            await fetch(`${API_BASE}/tag/create-list-of-tags`,{
                method:"POST",
                headers:{"Content-Type":"application/json","Authorization":token},
                body: JSON.stringify(newTagsInput.map(t=>({tagName:t})))
            });
        }

        selectedCategories.forEach(c=>formData.append("category",c));
        selectedTags.forEach(t=>formData.append("tags",t));

        const res = await fetch(`${API_BASE}/courses/create-course`,{
            method:"POST",
            headers:{Authorization:token},
            body:formData
        });

        if(res.ok){
            alert("Course created successfully!");
            form.reset();
            selectedCategories.clear();
            selectedTags.clear();
            renderSelectedCategories();
            renderSelectedTags();
            loadCategories();
            loadTags();
            document.getElementById("imagePreview").classList.add("hidden");
        } else alert("Course creation failed!");
    });

    loadCategories();
    loadTags();
</script>
</body>
</html>
